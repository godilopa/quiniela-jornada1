<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quiniela — Jornada 1</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:20px;background:#f7fafc}
    .card{background:#fff;padding:16px;border-radius:8px;box-shadow:0 6px 18px rgba(10,10,10,0.06);margin-bottom:16px}
    h1{margin-top:0}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #e6e6e6;padding:8px;text-align:center}
    select,input{padding:6px;border-radius:6px;border:1px solid #ddd}
    .small{font-size:13px;color:#555}
    .error{color:#b00020}
    .success{color:green}
    button{padding:10px 14px;border-radius:8px;border:0;background:#0ea5a4;color:#fff;cursor:pointer}
  </style>
</head>
<body>
  <div class="card">
    <h1>Quiniela — Jornada 1</h1>
    <p class="small">He corregido la lista de partidos según la composición oficial de boletos (SELAE / "Próximas jornadas deportivas"). Si quieres que cambie algún equipo o cargar otra jornada, dímelo.</p>

    <label>Tipo de quiniela:
      <select id="tipoQuiniela">
        <option value="12_1t_7d">Reducida al 12 — 1 triple y 7 dobles</option>
        <option value="12_2t_6d">Reducida al 12 — 2 triples y 6 dobles</option>
        <option value="13_0t_6d">Reducida al 13 — 0 triples y 6 dobles</option>
        <option value="13_1t_6d">Reducida al 13 — 1 triple y 6 dobles</option>
      </select>
    </label>

    <div style="overflow:auto;margin-top:12px">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Partido</th>
            <th>Tipo</th>
            <th>1</th>
            <th>X</th>
            <th>2</th>
            <th>Base</th>
          </tr>
        </thead>
        <tbody id="matchesBody"></tbody>
      </table>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Pleno al 15 — Elche vs Betis (elige goles para cada equipo)</h3>
      <div style="display:flex;gap:12px;align-items:center">
        <div>
          <div class="small">Local (Elche)</div>
          <select id="plenoLocal">
            <option value="">--</option>
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="M">M</option>
          </select>
        </div>
        <div>
          <div class="small">Visitante (Real Betis)</div>
          <select id="plenoVisitante">
            <option value="">--</option>
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="M">M</option>
          </select>
        </div>
      </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:12px;align-items:center">
      <button id="sendBtn">Enviar a Google Sheets</button>
      <div id="status" class="small"></div>
    </div>
  </div>

<script>
// === PARTIDOS oficiales (Jornada 1) ===
// Fuente: SELAE - "Proximas_jornadas_deportivas.pdf" (Composición de boletos - Jornada 1).
const matches = [
  {id:1, home:'Girona', away:'Rayo Vallecano'},
  {id:2, home:'Villarreal', away:'Real Oviedo'},
  {id:3, home:'Deportivo Alavés', away:'Levante UD'},
  {id:4, home:'Mallorca', away:'FC Barcelona'},
  {id:5, home:'Valencia CF', away:'Real Sociedad'},
  {id:6, home:'Celta de Vigo', away:'Getafe CF'},
  {id:7, home:'Athletic Club', away:'Sevilla FC'},
  {id:8, home:'RCD Espanyol', away:'Atlético de Madrid'},
  {id:9, home:'Racing Santander', away:'CD Castellón'},
  {id:10, home:'Málaga CF', away:'SD Eibar'},
  {id:11, home:'Granada CF', away:'Deportivo de La Coruña'},
  {id:12, home:'Cádiz CF', away:'CD Mirandés'},
  {id:13, home:'SD Huesca', away:'CD Leganés'},
  {id:14, home:'UD Las Palmas', away:'FC Andorra'},
  // 15 es Pleno al 15: Elche - Real Betis
  {id:15, home:'Elche CF', away:'Real Betis'}
];

const matchesBody = document.getElementById('matchesBody');

function buildTable(){
  matchesBody.innerHTML = '';
  // render only 1..14 as filas normales; la 15 queda para Pleno
  matches.slice(0,14).forEach(m => {
    const tr = document.createElement('tr');
    tr.dataset.id = m.id;

    tr.innerHTML = `
      <td>${m.id}</td>
      <td style="text-align:left">${m.home} - ${m.away}</td>
      <td>
        <select class="tipo">
          <option value="S">Simple</option>
          <option value="D">Doble</option>
          <option value="T">Triple</option>
        </select>
      </td>
      <td><input type="checkbox" class="opt" value="1"></td>
      <td><input type="checkbox" class="opt" value="X"></td>
      <td><input type="checkbox" class="opt" value="2"></td>
      <td>
        <select class="base" disabled>
          <option value="">--</option>
        </select>
      </td>
    `;

    matchesBody.appendChild(tr);

    // attach listeners
    const checkboxes = tr.querySelectorAll('input.opt');
    const tipoSel = tr.querySelector('select.tipo');
    const baseSel = tr.querySelector('select.base');

    // when tipo changes, enforce limits
    tipoSel.addEventListener('change', ()=>{
      enforceLimits(tr);
      updateBase(tr);
    });

    // when any checkbox changes
    checkboxes.forEach(cb => cb.addEventListener('change', ()=>{
      // auto-update tipo according to number of checked
      const checkedCount = tr.querySelectorAll('input.opt:checked').length;
      if(checkedCount >= 3) tipoSel.value = 'T';
      else if(checkedCount === 2) tipoSel.value = 'D';
      else if(checkedCount <= 1) tipoSel.value = 'S';

      enforceLimits(tr);
      updateBase(tr);
    }));

  });
}

function enforceLimits(tr){
  const tipo = tr.querySelector('select.tipo').value;
  const boxes = Array.from(tr.querySelectorAll('input.opt'));
  const checked = boxes.filter(b=>b.checked);
  if(tipo === 'S'){
    // keep only the first checked
    if(checked.length > 1){
      boxes.forEach((b,i)=> b.checked = (i===0 && checked.includes(b)) );
    }
  } else if(tipo === 'D'){
    if(checked.length > 2){
      let kept = 0;
      boxes.forEach(b=>{ if(b.checked){ if(kept < 2){ kept++; } else { b.checked = false; } } });
    }
  } // T allows all
}

function updateBase(tr){
  const boxes = Array.from(tr.querySelectorAll('input.opt'));
  const checked = boxes.filter(b=>b.checked).map(b=>b.value);
  const baseSel = tr.querySelector('select.base');

  // rebuild options
  baseSel.innerHTML = '';
  if(checked.length === 0){
    baseSel.disabled = true;
    const o = document.createElement('option'); o.value=''; o.textContent='--'; baseSel.appendChild(o);
    return;
  }
  // add options from checked
  const empty = document.createElement('option'); empty.value=''; empty.textContent='--'; baseSel.appendChild(empty);
  checked.forEach(v=>{ const o = document.createElement('option'); o.value = v; o.textContent = v; baseSel.appendChild(o); });
  baseSel.disabled = false;

  // auto-select base when applicable: if only one checked -> pick it
  if(checked.length === 1){ baseSel.value = checked[0]; }
  // if previous value still valid, keep it
  else if(!checked.includes(baseSel.value)) baseSel.value = '';
}

// build UI
buildTable();

// === Envío y validaciones ===
const mapping = {
  '12_1t_7d':{triples:1,doubles:7},
  '12_2t_6d':{triples:2,doubles:6},
  '13_0t_6d':{triples:0,doubles:6},
  '13_1t_6d':{triples:1,doubles:6}
};

document.getElementById('sendBtn').addEventListener('click', async ()=>{
  const tipoQuiniela = document.getElementById('tipoQuiniela').value;
  const expected = mapping[tipoQuiniela];
  const rows = Array.from(document.querySelectorAll('#matchesBody tr'));
  let triples = 0, doubles = 0;
  const entries = [];
  const errors = [];

  rows.forEach(tr=>{
    const id = tr.dataset.id;
    const matchText = tr.querySelector('td:nth-child(2)').textContent;
    const tipo = tr.querySelector('select.tipo').value;
    const selections = Array.from(tr.querySelectorAll('input.opt:checked')).map(cb=>cb.value);
    const base = tr.querySelector('select.base').value;

    if(tipo === 'T') triples++;
    if(tipo === 'D') doubles++;

    // checks
    if(selections.length === 0) errors.push(`Partido ${id} (${matchText}): selecciona al menos una opción.`);
    if(tipo === 'S' && selections.length !== 1) errors.push(`Partido ${id}: marcado como SIMPLE pero debe tener 1 selección.`);
    if(tipo === 'D' && selections.length !== 2) errors.push(`Partido ${id}: marcado como DOBLE pero debe tener 2 selecciones.`);
    if(tipo === 'T' && selections.length !== 3) errors.push(`Partido ${id}: marcado como TRIPLE pero debe tener 3 selecciones.`);
    if(!base) errors.push(`Partido ${id}: la columna Base debe estar establecida.`);
    if(base && !selections.includes(base)) errors.push(`Partido ${id}: la Base (${base}) no coincide con las selecciones.`);

    entries.push({id, match: matchText, tipo, selections, base});
  });

  // validate triples/doubles count
  if(triples !== expected.triples) errors.push(`Se esperaban ${expected.triples} triples pero hay ${triples}.`);
  if(doubles !== expected.doubles) errors.push(`Se esperaban ${expected.doubles} dobles pero hay ${doubles}.`);

  // pleno
  const plenoLocal = document.getElementById('plenoLocal').value;
  const plenoVisitante = document.getElementById('plenoVisitante').value;
  if(!plenoLocal) errors.push('Pleno al 15: elige los goles del equipo local (Elche).');
  if(!plenoVisitante) errors.push('Pleno al 15: elige los goles del equipo visitante (Real Betis).');

  const status = document.getElementById('status');
  if(errors.length){ status.innerHTML = `<span class="error">${errors.join('<br>')}</span>`; return; }

  // payload
  const payload = {
    tipoQuiniela,
    expected,
    summary:{triples,doubles},
    entries,
    pleno15:{ local:plenoLocal, away:plenoVisitante }
  };

  status.textContent = 'Enviando...';

	fetch('https://script.google.com/macros/s/AKfycbyjTrn3m5aNGiloEMkAyemQ8gjAb6nxOtdDPFc2L713C4zh_6aU6jKELhsIer3UlZwJ/exec', {
	  method: 'POST',
	  mode: 'cors',
	  // You can remove the 'Content-Type' header entirely
	  // and send the data as a simple object.
	  // Alternatively, if the Apps Script expects form data, you'd use a different approach.
	  body: JSON.stringify({ tipoQuiniela, partidos: entries, pleno15: { local: plenoLocal, visitante: plenoVisitante } })
	})
	.then(r => r.json())
	.then(resp => {
	  // ... (rest of the code)
	})
	.catch(err => {
	  // ... (rest of the code)
	});
});

</script>
</body>
</html>
